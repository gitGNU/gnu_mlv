#!/bin/bash

# Compilation de la librairie MLV

#
#   This file is part of the MLV Library.
#
#   Copyright (C) 2010,2011,2012,2013 Adrien Boussicault, Marc Zipstein
#
#
#    This library is free software: you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation, either version 3 of the License, or
#    (at your option) any later version.
#
#    This library is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this Library.  If not, see <http://www.gnu.org/licenses/>.
#



WINDOWS_DIRECTORY="`pwd`"
TOP_CROSS="$WINDOWS_DIRECTORY/cross-compilation"
CROSS_DIRECTORY=$TOP_CROSS/fakeroot-mingw32

MAIN_win32=$WINDOWS_DIRECTORY/@PACKAGE_TARNAME@-@PACKAGE_VERSION@-win32
MAIN_DEV=$WINDOWS_DIRECTORY/@PACKAGE_TARNAME@-@PACKAGE_VERSION@-canonical-developpement-kit

rm -rf $MAIN_DEV

(
if ! test -a $MAIN_win32/gpl.txt;
then
	./create_win32_binaries
fi
)

MLV_EXAMPLES=$MAIN_DEV/MLV_examples
MLV_MY_PROJECT=$MAIN_DEV/my_project


mkdir -p $MAIN_DEV

#Ajout de la documentation :
MLV_SRC=$CROSS_DIRECTORY/src/@PACKAGE_TARNAME@-@PACKAGE_VERSION@
(
cd $MLV_SRC
for i in ./doc/api/*
do
	base=`basename $i`
	mkdir -p $MAIN_DEV/documentation/$base
	cp -r $i/html/* $MAIN_DEV/documentation/$base/
done
)


#Creation d'un projet vide :
cp -r $MAIN_win32 $MLV_MY_PROJECT

mkdir $MLV_MY_PROJECT/obj 
mv $MLV_MY_PROJECT/bin $MLV_MY_PROJECT/final_product 
mkdir $MLV_MY_PROJECT/sources

cp @abs_top_srcdir@/examples/beginner/01_hello_world.c $MLV_MY_PROJECT/sources/main.c



# Creation des exampes pour la librairie MLV
MLV_EXAMPLES=$MAIN_DEV/MLV_examples

cp -r $MLV_MY_PROJECT $MLV_EXAMPLES
rm -rf $MLV_EXAMPLES/sources/main.c

#On ajoute le code source des examples
mkdir $MLV_EXAMPLES/sources/beginner
mkdir $MLV_EXAMPLES/sources/medium
mkdir $MLV_EXAMPLES/sources/advanced

mkdir $MLV_EXAMPLES/final_product/data/musics
for i in beginner medium advanced; do
	for j in @abs_top_srcdir@/examples/$i/*.ogg; do
		if test -f $j;
		then
			cp $j $MLV_EXAMPLES/final_product/data/musics/
		fi
	done;
done;

mkdir $MLV_EXAMPLES/final_product/data/images
for i in beginner medium advanced; do
	for j in @abs_top_srcdir@/examples/$i/*.png @abs_top_srcdir@/examples/$i/*.jpg; do
		if test -f $j;
		then
			cp $j $MLV_EXAMPLES/final_product/data/images/
		fi
	done;
done;

mkdir $MLV_EXAMPLES/final_product/data/configuration_files
for i in beginner medium advanced; do
	for j in @abs_top_srcdir@/examples/$i/*.xml; do
		if test -f $j;
		then
			cp $j $MLV_EXAMPLES/final_product/data/configuration_files/
		fi
	done;
done;

for i in beginner medium advanced; do
	for j in @abs_top_srcdir@/examples/$i/*.ttf; do
		if test -f $j;
		then
			cp $j $MLV_EXAMPLES/final_product/data/font/
		fi
	done;
done;

for i in beginner medium advanced; do
	for j in @abs_top_srcdir@/examples/$i/*.c; do
		name=`echo "$j" | sed -e 's#.*/\([^/]*\)*$#\1#g'`
		cat $j | 
		sed -e 's#"\([^"]*\.ttf\)"#"./data/font/\1"#g' | \
		sed -e 's#"\([^"]*\.ogg\)"#"./data/musics/\1"#g' | \
		sed -e 's#"\([^"]*\.mp3\)"#"./data/musics/\1"#g' | \
		sed -e 's#"\([^"]*\.png\)"#"./data/images/\1"#g' | \
		sed -e 's#"\([^"]*\.jpg\)"#"./data/images/\1"#g' | \
		sed -e 's#"\([^"]*\.xml\)"#"./data/configuration_files/\1"#g' | \
		sed -e 's#\(MLV_load_animation_book[ \t\r]*([ \t\r]*[^,]*[ \t\r]*,[ \t\r]*\)NULL\([ \t\r]*,[ \t\r]*\)NULL\([ \t\r]*)\)#\1\"./data/images\"\2\"./data/musics\"\3#g' > \
		$MLV_EXAMPLES/sources/$i/$name
	done;
done;

cp @abs_top_srcdir@/examples/beginner/gpl.txt $MLV_EXAMPLES/sources/beginner





#Creation des executable pour chaque exemple
# Creation des exampes pour la librairie MLV
MLV_FINAL_PRODUCT=$MLV_EXAMPLES/final_product

source $TOP_CROSS/definition_of_environement_variables


(
cd $MLV_EXAMPLES/sources
for i in **/*.c;
do
	j=`echo $i | sed -e "s#/#_#" | sed -e "s#\.c##"`;
	path=`echo $i | sed -e "s#/.*##"`;
	name=`echo $j | sed -e "s#^[^_]*_##"`;
	
	#compilation des exemples:
	$CC -g -pg -O2 -Wall $( \
		PKG_CONFIG_PATH=$CROSS_DIRECTORY/lib/pkgconfig pkg-config --cflags MLV \
	) $i $( \
		PKG_CONFIG_PATH=$CROSS_DIRECTORY/lib/pkgconfig pkg-config --libs MLV \
	) -o $MLV_FINAL_PRODUCT/$j.exe
done;
)



