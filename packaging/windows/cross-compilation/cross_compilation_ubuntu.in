#!/bin/bash

#
#   This file is part of the MLV Library.
#
#   Copyright (C) 2010,2011,2012,2013 Adrien Boussicault, Marc Zipstein
#
#
#    This library is free software: you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation, either version 3 of the License, or
#    (at your option) any later version.
#
#    This library is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this Library.  If not, see <http://www.gnu.org/licenses/>.
#

source definition_of_environement_variables

print_green "Copy of the external libraries ..."
mkdir $FAKE32 
mkdir $FAKE32_SRC
cp @abs_top_srcdir@/packaging/windows/cross-compilation/external_libraries/* $FAKE32_SRC

print_green "Making gettext"
cd  $FAKE32_SRC
unzip mingw32-gettext-0.17-7.zip
cp -r mingw32-gettext-0.17-7/* ../
rm -rf mingw32-gettext-0.17-7

print_green "Making glib2"
unzip mingw32-glib2-2.19.5-2.zip
cp -r mingw32-glib2-2.19.5-2/* ../
rm -rf mingw32-glib2-2.19.5-2

print_green "Making iconv"
unzip mingw32-iconv-1.12-7.zip
cp -r mingw32-iconv-1.12-7/* ../
rm -rf mingw32-iconv-1.12-7

print_green "Making SDL"
tar -xzf SDL-1.2.13.tar.gz
cd SDL-1.2.13/
./configure --prefix=$FAKE32 --host="$HOST"
make
make install
cd ..

print_green "Making SDL_gfx"
tar -xzf SDL_gfx-2.0.19.tar.gz
cd SDL_gfx-2.0.19/
sed -e "s/\tgcc/\t\$(CC)/" Makefile.mingw > tmp && mv tmp Makefile.mingw
make -f Makefile.mingw install RANLIB="$RANLIB" AR="$AR" CC="$CC" prefix=$FAKE32 CPPFLAGS="-I$FAKE32/include" LDFALGS="-L$FAKE32/lib"
cp SDL_gfx.dll $FAKE32/bin/
cd ..


print_green "Making free type"
tar -xzf freetype-2.3.9.tar.gz
cd freetype-2.3.9/
./configure --prefix=$FAKE32 --host="$HOST"
make
make install
cd ..

print_green "Making zlib"
tar -xzf zlib-1.2.3.tar.gz
cd zlib-1.2.3
cp win32/Makefile.gcc .
sed -e "s/dllwrap/i586-mingw32msvc-dllwrap/" Makefile.gcc > tmp && mv tmp Makefile.gcc
sed -e "s/strip/i586-mingw32msvc-strip/" Makefile.gcc > tmp && mv tmp Makefile.gcc
make -f Makefile.gcc  RANLIB="$RANLIB" RC="$RC" AR="$AR_WITHOUT_RC" CC="$CC" prefix=$FAKE32 CPPFLAGS="-DWIN32 -I$FAKE32/include -I$FAKE32/include/glib-2.0 -I$FAKE32/lib/glib-2.0/include" LDFLAGS="-L$FAKE32/lib -L/usr/i586-mingw32msvc/lib" 
make -f Makefile.gcc  RANLIB="$RANLIB" RC="$RC" AR="$AR_WITHOUT_RC" CC="$CC" prefix=$FAKE32 CPPFLAGS="-DWIN32 -I$FAKE32/include -I$FAKE32/include/glib-2.0 -I$FAKE32/lib/glib-2.0/include" LDFLAGS="-L$FAKE32/lib -L/usr/i586-mingw32msvc/lib" INCLUDE_PATH=$FAKE32/include LIBRARY_PATH=$FAKE32/lib install
cp zlib1.dll ../../bin/
cp ../libz.la ../../lib/
cd ..


print_green "Making SDL_ttf"
tar -xzf SDL_ttf-2.0.9.tar.gz
cd SDL_ttf-2.0.9/
cp ../../bin/SDL.dll .
./configure --prefix=$FAKE32 --host="$HOST" --with-freetype-prefix=$FAKE32
make  RANLIB="$RANLIB" RC="$RC" AR="$AR" CC="$CC" prefix=$FAKE32 CPPFLAGS="-DWIN32 -I$FAKE32/include -I$FAKE32/include/glib-2.0 -I$FAKE32/lib/glib-2.0/include" LDFLAGS="-L$FAKE32/lib -L/usr/i586-mingw32msvc/lib" 
make RANLIB="$RANLIB" RC="$RC" AR="$AR" CC="$CC" prefix=$FAKE32 CPPFLAGS="-DWIN32 -I$FAKE32/include -I$FAKE32/include/glib-2.0 -I$FAKE32/lib/glib-2.0/include" LDFLAGS="-L$FAKE32/lib -L/usr/i586-mingw32msvc/lib" INCLUDE_PATH=$FAKE32/include LIBRARY_PATH=$FAKE32/lib install
cd ..

print_green "Patch some .la files"
for i in ../lib/libasprintf.la ../lib/libcharset.la ../lib/libgettextlib.la ../lib/libgettextpo.la ../lib/libgettextsrc.la ../lib/libgio-2.0.la ../lib/libglib-2.0.la ../lib/libgmodule-2.0.la ../lib/libgobject-2.0.la ../lib/libgthread-2.0.la ../lib/libiconv.la ../lib/libintl.la; do cat $i | sed -e "s#/usr/i686-pc-mingw32/sys-root/mingw#$FAKE32#g" > tmp; cp tmp $i; done;

print_green "Making libpng"
tar -xzf libpng-1.4.1.tar.gz
cd libpng-1.4.1/
CPPFLAGS="-DWIN32 -I$FAKE32/include -I$FAKE32/include/glib-2.0 -I$FAKE32/lib/glib-2.0/include" LDFLAGS="-L$FAKE32/lib -L/usr/i586-mingw32msvc/lib" ./configure --prefix=$FAKE32 --host="$HOST"
make  RANLIB="$RANLIB" RC="$RC" AR="$AR" CC="$CC" prefix=$FAKE32 CPPFLAGS="-DWIN32 -I$FAKE32/include -I$FAKE32/include/glib-2.0 -I$FAKE32/lib/glib-2.0/include" LDFLAGS="-L$FAKE32/lib -L/usr/i586-mingw32msvc/lib"
make install
cd ..

print_green "Making jpeg"
tar -xzf jpegsrc.v8d.tar.gz
cd jpeg-8d
CPPFLAGS="-DWIN32 -I$FAKE32/include -I$FAKE32/include/glib-2.0 -I$FAKE32/lib/glib-2.0/include" LDFLAGS="-L$FAKE32/lib -L/usr/i586-mingw32msvc/lib" ./configure --prefix=$FAKE32 --host="$HOST"
make  RANLIB="$RANLIB" RC="$RC" AR="$AR" CC="$CC" prefix=$FAKE32 CPPFLAGS="-DWIN32 -I$FAKE32/include -I$FAKE32/include/glib-2.0 -I$FAKE32/lib/glib-2.0/include" LDFLAGS="-L$FAKE32/lib -L/usr/i586-mingw32msvc/lib"
make install
cd ..

print_green "Making tiff"
tar -xzf tiff-4.0.1.tar.gz
cd tiff-4.0.1
CPPFLAGS="-DWIN32 -I$FAKE32/include -I$FAKE32/include/glib-2.0 -I$FAKE32/lib/glib-2.0/include" LDFLAGS="-L$FAKE32/lib -L/usr/i586-mingw32msvc/lib" ./configure --prefix=$FAKE32 --host="$HOST"
make  RANLIB="$RANLIB" RC="$RC" AR="$AR" CC="$CC" prefix=$FAKE32 CPPFLAGS="-DWIN32 -I$FAKE32/include -I$FAKE32/include/glib-2.0 -I$FAKE32/lib/glib-2.0/include" LDFLAGS="-L$FAKE32/lib -L/usr/i586-mingw32msvc/lib"
make install
cd ..

print_green "Making SDL_image"
tar -xzf SDL_image-1.2.10.tar.gz
cd SDL_image-1.2.10
CPPFLAGS="-DWIN32 -I$FAKE32/include -I$FAKE32/include/glib-2.0 -I$FAKE32/lib/glib-2.0/include" LDFLAGS="-L$FAKE32/lib -L/usr/i586-mingw32msvc/lib"  LIBS="-lpng14 $FAKE32/lib/libpng.a -lz" ./configure --prefix=$FAKE32 --host="$HOST" --target="$TARGET" --build="$BUILD" --with-sdl-prefix=$FAKE32
make  RANLIB="$RANLIB" RC="$RC" AR="$AR" CC="$CC" prefix=$FAKE32 CPPFLAGS="-DWIN32 -I$FAKE32/include -I$FAKE32/include/glib-2.0 -I$FAKE32/lib/glib-2.0/include" LDFLAGS="-L$FAKE32/lib -L/usr/i586-mingw32msvc/lib"

make install 
cd ..

# print_green "Making libogg"
#tar -xzf libogg-1.2.0.tar.gz 
#cd libogg-1.2.0/
#./configure  --prefix=$FAKE32 --host=i586-mingw32msvc --target=i586-mingw32msvc --build=i586-linux
#make
#make check
#make install
#cd ..
#
# print_green "Making libvorbis"
#tar -xjf libvorbis-1.3.1.tar.bz2
#cd libvorbis-1.3.1/
#CPPFLAGS="-DWIN32 -I$FAKE32/include -I$FAKE32/include/glib-2.0 -I$FAKE32/lib/glib-2.0/include" LDFLAGS="-L$FAKE32/lib -L/usr/i586-mingw32msvc/lib" ./configure --prefix=$FAKE32 --host=i586-mingw32msvc --target=i586-mingw32msvc --build=i586-linux
#make
#make install
#cd ..
#
# print_green "Making flac"
#tar -xzf flac-1.2.1.tar.gz
#cd flac-1.2.1/
#CPPFLAGS="-DWIN32 -I$FAKE32/include -I$FAKE32/include/glib-2.0 -I$FAKE32/lib/glib-2.0/include" LDFLAGS="-L$FAKE32/lib -L/usr/i586-mingw32msvc/lib" ./configure --prefix=$FAKE32 --host=i586-mingw32msvc --target=i586-mingw32msvc --build=i586-linux
#make
#make install
#cd ..
#
# print_green "Making libkmod"
#tar -xzf libmikmod-3.2.0.tar.gz
#cd libmikmod-3.2.0
#CPPFLAGS="-DWIN32 -I$FAKE32/include" LDFLAGS="-L$FAKE32/lib -L/usr/i586-mingw32msvc/lib"  LIBS="-lz" ./configure --prefix=$FAKE32 --host="$HOST" --target="$TARGET" --build="$BUILD" --with-sdl-prefix=$FAKE32
#make  RANLIB="$RANLIB" RC="$RC" AR="$AR" CC="$CC" prefix=$FAKE32 CPPFLAGS="-DWIN32 -I$FAKE32/include" LDFLAGS="-L$FAKE32/lib -L/usr/i586-mingw32msvc/lib"
#make install
#cd ..
#
# print_green "Making SDL_mixer"
#tar -xzf SDL_mixer-1.2.11.tar.gz
#cd SDL_mixer-1.2.11/
#CPPFLAGS="-DWIN32 -I$FAKE32/include -I$FAKE32/include/glib-2.0 -I$FAKE32/lib/glib-2.0/include" LDFLAGS="-L$FAKE32/lib -L/usr/i586-mingw32msvc/lib" ./configure --prefix=$FAKE32 --host=i586-mingw32msvc --target=i586-mingw32msvc --build=i586-linux  --with-sdl-prefix=$FAKE32
#make
#make install
#cd ..

print_green "Making libxml2"
tar -xzf libxml2-git-snapshot.tar.gz
cd libxml2-2.7.7/
mkdir m4
CPPFLAGS="-DWIN32 -I$FAKE32/include -I$FAKE32/include/glib-2.0 -I$FAKE32/lib/glib-2.0/include" LDFLAGS="-L$FAKE32/lib -L/usr/i586-mingw32msvc/lib" ./configure --prefix=$FAKE32 --host="$HOST" --target="$TARGET" --build="$BUILD"  --with-sdl-prefix=$FAKE32 --without-zlib --without-python
make
make install 
cd ..

print_green "Making SDL_mixer"
unzip -o SDL_mixer-1.2.12-win32.zip -d ../bin/
unzip -o SDL_mixer-devel-1.2.12-VC.zip
cp -r SDL_mixer-1.2.12/include/SDL_mixer.h ../include/SDL/
cp libSDL_mixer.la ../lib/
cp ../bin/SDL_mixer.dll ../lib/

print_green "Making libstdc++ and libgcc"
cp libstdc++-6.dll libgcc_s_dw2-1.dll ../bin/

print_green "We remove -lmingw32 and -lSDLmain inside all .la file to allow DLL compilation."
(
cd $FAKE32/lib
for i in *.la
do
	sed $i -e "s/-lmingw32//g" | sed -e "s/-lSDLmain//g" > $i.tmp.1
	mv $i.tmp.1 $i
done
)

print_green "$0 is finished."
